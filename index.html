<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teilungsverhältnisse – langsamer + Schritte nebeneinander</title>

<style>
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
  body { margin:0; background:#f4f4f4; display:flex; justify-content:center; }
  .app{
    background:#fff; max-width: 1120px; width:100%;
    margin:12px; padding:12px; border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
  }
  h1 { margin: 6px 0 10px; text-align:center; font-size:18px; }

  .top { display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap; }
  .meta { font-size:12px; color:#555; }

  .card { margin-top:10px; border:1px solid #e5e5e5; border-radius:12px; padding:12px; background:#fff; }
  .cat { font-size:12px; font-weight:900; color:#444; margin-bottom:6px; }
  .title { font-weight:900; font-size:16px; margin-bottom:8px; }
  .text { font-size:14px; color:#222; line-height:1.35; }
  .text b { font-weight:900; }

  .prompt { margin-top:10px; font-weight:900; font-size:14px; color:#222; }

  .answers { display:grid; gap:8px; margin-top:10px; }
  .answer{
    border:1px solid #ccc; border-radius:12px; padding:10px;
    background:#fafafa; cursor:pointer; font-size:14px;
  }
  .answer:hover { background:#f0f0f0; }
  .answer.disabled { pointer-events:none; opacity:.95; }
  .answer.correct { background:#d4edda; border-color:#28a745; }
  .answer.wrong { background:#f8d7da; border-color:#dc3545; }

  .feedback { margin-top:10px; font-weight:900; min-height:22px; }

  .controls { margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  .btn{
    padding:8px 12px; border:none; border-radius:12px;
    background:#007bff; color:#fff; cursor:pointer; font-size:13px;
  }
  .btn:hover { background:#0062cc; }
  .btn.secondary { background:#222; }
  .btn.secondary:hover { background:#000; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* ===== Visual ===== */
  :root{
    --A: rgba(255, 120, 120, .75);
    --B: rgba(120, 170, 255, .75);
    --outline:#333;
    --glow: rgba(255, 215, 0, .95);
  }

  .visualRow { margin-top:12px; display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap; }
  .vizCard{
    flex:1 1 560px;
    border:1px solid #e5e5e5; border-radius:12px; padding:12px;
    background:#fcfcfc;
  }
  .vizTitle{ font-weight:900; margin-bottom:10px; font-size:13px; color:#222; }

  .bar{
    width:100%; height:72px;
    border:2px solid var(--outline); border-radius:14px;
    overflow:hidden; display:flex; background:#fff;
  }

  .part{
    height:100%;
    border-right:1px solid rgba(0,0,0,.25);
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size:18px; color:#111;
    user-select:none;
    position:relative;
    transition: outline .18s ease, transform .18s ease, filter .18s ease;
  }
  .part:last-child{ border-right:none; }
  .partA{ background:var(--A); }
  .partB{ background:var(--B); }

  .part.highlight{
    outline: 5px solid var(--glow);
    outline-offset: -5px;
    transform: translateY(-1px) scale(1.01);
    filter: brightness(1.03);
    z-index:1;
  }

  .part.groupHighlight{
    outline: 5px solid var(--glow);
    outline-offset: -5px;
    filter: brightness(1.03);
  }

  .part .num{
    padding:3px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.80);
    border:1px solid rgba(0,0,0,.25);
    min-width:40px;
    text-align:center;
  }

  .legend{ margin-top:10px; font-size:12px; color:#444; line-height:1.25; }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 12px; border-radius:999px;
    border:1px solid #ddd; background:#fff; font-weight:900;
    margin-right:10px; margin-bottom:6px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid rgba(0,0,0,.25); }
  .dotA{ background:var(--A); }
  .dotB{ background:var(--B); }

  /* ===== Schritte: nebeneinander (3 Spalten) ===== */
  .stepsPanel{
    flex:1 1 520px;
    border:1px solid #e5e5e5; border-radius:12px;
    background:#fff;
    padding:12px;
    min-width:520px;
  }
  .stepsTitle{
    font-weight:1000;
    font-size:14px;
    margin-bottom:10px;
  }
  .stepsGrid{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr; /* nebeneinander */
    gap:10px;
    align-items:stretch;
  }
  .stepBox{
    border:1px solid #eee;
    background:#fafafa;
    border-radius:12px;
    padding:10px;
    min-height:104px;
  }
  .stepNr{ font-weight:1000; font-size:13px; margin-bottom:6px; }
  .stepText{ font-weight:1000; font-size:14px; margin-bottom:6px; }
  .eq{
    display:inline-block;
    font-weight:1000;
    font-size:20px;
    padding:8px 12px;
    border-radius:12px;
    background:#fff;
    border:1px solid #ddd;
    white-space:nowrap; /* damit's nicht umbricht */
  }
  .eq .hl{
    background: rgba(255,215,0,.25);
    padding:0 4px;
    border-radius:6px;
  }

  .stepHidden{
    opacity:0;
    transform: translateY(6px);
    pointer-events:none;
  }
  .stepShown{
    opacity:1;
    transform: translateY(0);
    pointer-events:auto;
    transition: opacity .35s ease, transform .35s ease;
  }

  .step3A{ background: rgba(255,120,120,.14) !important; border-color: rgba(255,120,120,.35) !important; }
  .step3B{ background: rgba(120,170,255,.14) !important; border-color: rgba(120,170,255,.35) !important; }
  .eqA{ border-color: rgba(255,120,120,.55) !important; }
  .eqB{ border-color: rgba(120,170,255,.55) !important; }

  /* Responsive: wenn's wirklich zu eng wird, auf 2 Spalten + 1 darunter */
  @media (max-width: 980px){
    .stepsPanel{ min-width:320px; flex:1 1 340px; }
    .stepsGrid{ grid-template-columns: 1fr 1fr; }
    .stepBox:nth-child(3){ grid-column: 1 / -1; }
    .eq{ white-space:normal; }
  }
</style>
</head>

<body>
<div class="app">
  <h1>Teilungsverhältnisse – Aufteilen im Verhältnis</h1>

  <div class="top">
    <div class="meta" id="meta">0 / 0</div>
  </div>

  <div class="card">
    <div class="cat" id="cat"></div>
    <div class="title" id="title"></div>

    <div class="text" id="text"></div>

    <div id="visualRow" class="visualRow" style="display:none;">
      <div id="visual" class="vizCard"></div>
      <div id="stepsPanel" class="stepsPanel"></div>
    </div>

    <div class="prompt" id="prompt" style="display:none;"></div>
    <div id="answers" class="answers"></div>

    <div class="feedback" id="feedback"></div>

    <div class="controls">
      <button class="btn secondary" id="restartBtn">Neu starten</button>
      <button class="btn" id="nextBtn" disabled>Weiter</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Helpers
========================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function gcd(a,b){
  a=Math.abs(a); b=Math.abs(b);
  while(b){ const t=a%b; a=b; b=t; }
  return a || 1;
}
function simplifyRatio(a,b){
  const g=gcd(a,b);
  return [a/g, b/g];
}
function splitTotal(total, a, b){
  const sum = a + b;
  const one = total / sum;
  return {A: a*one, B: b*one, onePart: one, sumParts: sum};
}
function fmt(x){
  return Number.isInteger(x) ? String(x) : String(Math.round(x*100)/100);
}

/* =========================
   Visual: Balkenmodell
========================= */
function renderBarModel(cardEl, a, b, nameA="A", nameB="B"){
  const [aa, bb] = simplifyRatio(a,b);
  const sum = aa + bb;

  const parts = [];
  for(let i=0;i<sum;i++){
    const isA = i < aa;
    parts.push({cls: isA ? "partA" : "partB"});
  }

  cardEl.innerHTML = `
    <div class="vizTitle">Balkenmodell: Verhältnis <b>${aa}:${bb}</b></div>
    <div class="bar" id="bar">
      ${parts.map((p,idx) => `
        <div class="part ${p.cls}" data-idx="${idx}" style="width:${(100/sum).toFixed(3)}%">
          <div class="num"></div>
        </div>
      `).join("")}
    </div>

    <div class="legend">
      <span class="pill"><span class="dot dotA"></span>${nameA}: ${aa} Teile</span>
      <span class="pill"><span class="dot dotB"></span>${nameB}: ${bb} Teile</span><br>
      Insgesamt: <b>${sum}</b> gleich große Teile
    </div>
  `;

  setAllPartNumbers("");
  clearPartMarks();
}

/* ===== Balken/Teile steuern ===== */
function clearPartMarks(){
  const bar = document.getElementById("bar");
  if(!bar) return;
  [...bar.querySelectorAll(".part")].forEach(p => p.classList.remove("highlight","groupHighlight"));
}
function highlightPart(i){
  const bar = document.getElementById("bar");
  if(!bar) return;
  const p = bar.querySelector(`.part[data-idx="${i}"]`);
  if(p) p.classList.add("highlight");
}
function unhighlightPart(i){
  const bar = document.getElementById("bar");
  if(!bar) return;
  const p = bar.querySelector(`.part[data-idx="${i}"]`);
  if(p) p.classList.remove("highlight");
}
function highlightGroup(indices){
  const bar = document.getElementById("bar");
  if(!bar) return;
  indices.forEach(i => {
    const p = bar.querySelector(`.part[data-idx="${i}"]`);
    if(p) p.classList.add("groupHighlight");
  });
}
function setAllPartNumbers(val){
  const bar = document.getElementById("bar");
  if(!bar) return;
  [...bar.querySelectorAll(".part .num")].forEach(n => n.textContent = val);
}
function setPartNumber(i, val){
  const bar = document.getElementById("bar");
  if(!bar) return;
  const box = bar.querySelector(`.part[data-idx="${i}"] .num`);
  if(box) box.textContent = val;
}

/* =========================
   Schritte-Panel (3 Schritte nebeneinander)
========================= */
function renderStepsPanel(panelEl, s){
  const [aa, bb] = simplifyRatio(s.a, s.b);
  const sum = aa + bb;
  const calc = splitTotal(s.total, aa, bb);
  const one = fmt(calc.onePart);

  const target = s.askFor; // "A" oder "B"
  const targetName = (target === "A") ? s.nameA : s.nameB;
  const targetParts = (target === "A") ? aa : bb;
  const targetResult = (target === "A") ? fmt(calc.A) : fmt(calc.B);

  const step3Class = (target === "A") ? "step3A" : "step3B";
  const eq3Class   = (target === "A") ? "eqA" : "eqB";

  panelEl.innerHTML = `
    <div class="stepsTitle">Rechnung (erscheint nach deiner Antwort)</div>
    <div class="stepsGrid">
      <div class="stepBox stepHidden" id="step1Box">
        <div class="stepNr">Schritt 1</div>
        <div class="stepText">Auf wieviele Teile wird aufgeteilt?</div>
        <div class="eq"><span class="hl">${aa}</span> + <span class="hl">${bb}</span> = <span class="hl">${sum}</span></div>
      </div>

      <div class="stepBox stepHidden" id="step2Box">
        <div class="stepNr">Schritt 2</div>
        <div class="stepText">Wieviele ${s.thingPlural} sind ein Teil?</div>
        <div class="eq"><span class="hl">${s.total}</span> : <span class="hl">${sum}</span> = <span class="hl">${one}</span>${s.unit || ""}</div>
      </div>

      <div class="stepBox stepHidden ${step3Class}" id="step3Box">
        <div class="stepNr">Schritt 3</div>
        <div class="stepText">Wieviele ${s.thingPlural} bekommt ${targetName}?</div>
        <div class="eq ${eq3Class}"><span class="hl">${one}</span> · <span class="hl">${targetParts}</span> = <span class="hl">${targetResult}</span>${s.unit || ""}</div>
      </div>
    </div>
  `;
}

function showStepBox(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove("stepHidden");
  el.classList.add("stepShown");
}

/* =========================
   Ablauf nach Antwort (JETZT: ~3x langsamer)
========================= */
let timers = [];
function stopAnimation(){
  timers.forEach(t => clearTimeout(t));
  timers = [];
  clearPartMarks();
}

function runPostAnswerSequence(s){
  stopAnimation();

  // vorher war: 200 / 1200 / 2300
  // jetzt ~3x langsamer:
  const step1Delay = 600;
  const step2Delay = 3600;  // 3x
  const fillDelay  = 6900;  // 3x

  timers.push(setTimeout(() => showStepBox("step1Box"), step1Delay));
  timers.push(setTimeout(() => showStepBox("step2Box"), step2Delay));
  timers.push(setTimeout(() => animateFillPerPartThenStep3(s), fillDelay));
}

function animateFillPerPartThenStep3(s){
  stopAnimation();

  const [aa, bb] = simplifyRatio(s.a, s.b);
  const sum = aa + bb;
  const calc = splitTotal(s.total, aa, bb);
  const one = fmt(calc.onePart);

  setAllPartNumbers("");
  clearPartMarks();

  // vorher: start 200, perPart 850, holdAfter 650
  // jetzt ~3x langsamer:
  const startDelay = 600;
  const perPartDelay = 2550;
  const holdAfterFill = 1950;

  for(let i=0;i<sum;i++){
    timers.push(setTimeout(() => {
      clearPartMarks();
      highlightPart(i);
      setPartNumber(i, one);
    }, startDelay + i*perPartDelay));

    timers.push(setTimeout(() => {
      unhighlightPart(i);
    }, startDelay + i*perPartDelay + 1560)); // 520*3
  }

  const afterFill = startDelay + sum*perPartDelay + holdAfterFill;

  timers.push(setTimeout(() => {
    showStepBox("step3Box");
    clearPartMarks();

    if(s.askFor === "A"){
      const idx = [];
      for(let i=0;i<aa;i++) idx.push(i);
      highlightGroup(idx);
    } else {
      const idx = [];
      for(let i=aa;i<aa+bb;i++) idx.push(i);
      highlightGroup(idx);
    }
  }, afterFill));
}

/* =========================
   Aufgaben (mit askFor)
========================= */
function mkStoryMC({cat,title,thingPlural,total,unit,a,b,nameA,nameB,askFor,correctValue,distractors}){
  const question =
    askFor === "A" ? `Wie viele ${thingPlural} bekommt ${nameA}?` :
    `Wie viele ${thingPlural} bekommt ${nameB}?`;

  const text = `
    <p><b>Ich habe ${total}${unit} ${thingPlural}.</b></p>
    <p>Ich teile sie im Verhältnis <b>${a}:${b}</b> auf.</p>
    <p><b>${nameA} : ${nameB} = ${a} : ${b}</b></p>
  `;

  return {
    type:"mc",
    cat, title,
    thingPlural,
    total, unit, a, b, nameA, nameB,
    askFor,
    text,
    prompt: question,
    answers: shuffle([
      {t: correctValue + (unit || ""), ok:true},
      ...distractors.map(x => ({t: x + (unit || ""), ok:false}))
    ])
  };
}

const steps = [
  { type:"intro", cat:"Start", title:"Aufteilen im Verhältnis",
    text:`<p>Nach deiner Antwort erscheinen die 3 Schritte <b>nebeneinander</b> und die Animation läuft <b>sehr langsam</b>.</p>` },

  mkStoryMC({ cat:"Level 1", title:"Aufgabe 1",
    thingPlural:"Bonbons", total:5, unit:"",
    a:2,b:3, nameA:"Anna", nameB:"Ben",
    askFor:"A", correctValue:"2", distractors:["3","1","5"]
  }),

  mkStoryMC({ cat:"Level 1", title:"Aufgabe 2",
    thingPlural:"Bonbons", total:10, unit:"",
    a:2,b:3, nameA:"Anna", nameB:"Ben",
    askFor:"B", correctValue:"6", distractors:["4","5","8"]
  })
];

/* =========================
   UI
========================= */
let stepIndex = 0;
let answered = false;

const metaEl = document.getElementById("meta");
const catEl = document.getElementById("cat");
const titleEl = document.getElementById("title");
const textEl = document.getElementById("text");

const visualRowEl = document.getElementById("visualRow");
const visualCardEl = document.getElementById("visual");
const stepsPanelEl = document.getElementById("stepsPanel");

const promptEl = document.getElementById("prompt");
const answersEl = document.getElementById("answers");
const feedbackEl = document.getElementById("feedback");
const nextBtn = document.getElementById("nextBtn");
const restartBtn = document.getElementById("restartBtn");

function setMeta(){ metaEl.textContent = `${stepIndex + 1} / ${steps.length}`; }

function clearScreen(){
  stopAnimation();
  answersEl.innerHTML = "";
  feedbackEl.textContent = "";
  answered = false;
  nextBtn.disabled = true;

  promptEl.style.display = "none";
  promptEl.textContent = "";

  visualRowEl.style.display = "none";
  visualCardEl.innerHTML = "";
  stepsPanelEl.innerHTML = "";
}

function renderStep(){
  clearScreen();
  setMeta();

  const s = steps[stepIndex];
  catEl.textContent = s.cat || "";
  titleEl.textContent = s.title || "";
  textEl.innerHTML = s.text || "";

  if(s.type === "intro"){
    nextBtn.disabled = false;
    return;
  }

  visualRowEl.style.display = "flex";
  renderBarModel(visualCardEl, s.a, s.b, s.nameA || "A", s.nameB || "B");
  renderStepsPanel(stepsPanelEl, s);

  if(s.prompt){
    promptEl.style.display = "block";
    promptEl.textContent = s.prompt;
  }

  if(s.type === "mc") renderMC(s);
}

function afterAnswer(s){
  runPostAnswerSequence(s);
  nextBtn.disabled = false;
}

function renderMC(s){
  const order = shuffle(s.answers.map((_,i)=>i));
  order.forEach((idx) => {
    const a = s.answers[idx];
    const btn = document.createElement("div");
    btn.className = "answer";
    btn.textContent = a.t;

    btn.onclick = () => {
      if(answered) return;
      answered = true;
      [...answersEl.children].forEach(el => el.classList.add("disabled"));

      if(a.ok){
        btn.classList.add("correct");
        feedbackEl.textContent = "Richtig.";
      } else {
        btn.classList.add("wrong");
        feedbackEl.textContent = "Falsch.";
        [...answersEl.children].forEach((el) => {
          const txt = el.textContent;
          const found = s.answers.find(x => x.t === txt);
          if(found && found.ok) el.classList.add("correct");
        });
      }
      afterAnswer(s);
    };

    answersEl.appendChild(btn);
  });
}

nextBtn.onclick = () => {
  stepIndex++;
  if(stepIndex >= steps.length) stepIndex = 0;
  renderStep();
};
restartBtn.onclick = () => {
  stepIndex = 0;
  renderStep();
};

renderStep();
</script>
</body>
</html>


